name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name:  Build e Testes
    runs-on: ubuntu-latest

    steps:
      - name:  Checkout do código
        uses: actions/checkout@v3

      - name:  Configurar Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name:  Instalar dependências
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

      - name:  Rodar testes unitários
        run: |
          source venv/bin/activate
          pytest --junitxml=report.xml

      - name:  Analisar qualidade do código (Flake8)
        run: |
          source venv/bin/activate
          flake8 app --count --max-line-length=120 --statistics

  package:
    name:  Empacotamento
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name:  Checkout do código
        uses: actions/checkout@v3

      - name:  Criar pacote da aplicação
        run: |
          mkdir build
          cp -r app build/
          tar -czf build/app.tar.gz build/

      - name:  Armazenar artefato
        uses: actions/upload-artifact@v3
        with:
          name: app-package
          path: build/app.tar.gz

  deploy:
    name:  Deploy (Simulado)
    runs-on: ubuntu-latest
    needs: package

    steps:
      - name:  Baixar pacote da aplicação
        uses: actions/download-artifact@v3
        with:
          name: app-package
          path: build/

      - name:  Simulando Deploy
        run: echo " Deploy realizado com sucesso!"
